<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Reports - Accounting Record Book</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .report-section { display: none; }
        .active { display: block; }
        .report-nav { margin-bottom: 2rem; }
        .report-nav button { margin-right: 1rem; }
    </style>
</head>
<body>
    <header><h1>Accounting Record Book</h1></header>
    <nav>
        <a href="index.html">Dashboard</a>
        <a href="accounts.html">Chart of Accounts</a>
        <a href="journal.html">Journal Entries</a>
        <a href="reports.html">Financial Reports</a>
        <a href="#" onclick="api.logout()">Logout</a>
    </nav>
    <main>
        <div class="report-nav">
            <button class="btn btn-primary" onclick="showReport('general-ledger')">General Ledger</button>
            <button class="btn btn-primary" onclick="showReport('trial-balance')">Trial Balance</button>
            <button class="btn btn-primary" onclick="showReport('profit-loss')">Profit & Loss</button>
            <button class="btn btn-primary" onclick="showReport('balance-sheet')">Balance Sheet</button>
        </div>

        <!-- General Ledger -->
        <div id="general-ledger" class="report-section active card">
            <h2>General Ledger</h2>
            <div style="margin-bottom: 1rem;">
                <label>Select Account:</label>
                <select id="ledger-account-select" onchange="loadLedger()" class="form-control" style="display: inline-block; width: auto; margin-left: 1rem;">
                    <option value="">-- Choose Account --</option>
                </select>
            </div>
            <table id="ledger-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Reference</th>
                        <th>Description</th>
                        <th class="text-right">Debit</th>
                        <th class="text-right">Credit</th>
                        <th class="text-right">Balance</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Trial Balance -->
        <div id="trial-balance" class="report-section card">
            <h2>Trial Balance</h2>
            <table id="tb-table">
                <thead>
                    <tr>
                        <th>Account</th>
                        <th class="text-right">Debit</th>
                        <th class="text-right">Credit</th>
                    </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                    <tr class="total-row">
                        <td>Totals</td>
                        <td class="text-right" id="tb-total-debit"></td>
                        <td class="text-right" id="tb-total-credit"></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Profit & Loss -->
        <div id="profit-loss" class="report-section card">
            <h2>Profit & Loss Statement</h2>
            <div id="pl-content">
                <h3>Revenue</h3>
                <table id="pl-revenue-table"><tbody></tbody></table>
                <h3>Expenses</h3>
                <table id="pl-expense-table"><tbody></tbody></table>
                <hr>
                <div class="total-row" style="padding: 1rem; font-size: 1.2rem;">
                    Net Income: <span id="pl-net-income" class="text-right" style="float: right;"></span>
                </div>
            </div>
        </div>

        <!-- Balance Sheet -->
        <div id="balance-sheet" class="report-section card">
            <h2>Balance Sheet</h2>
            <div id="bs-content">
                <h3>Assets</h3>
                <table id="bs-assets-table"><tbody></tbody></table>
                <div class="total-row">Total Assets: <span id="bs-total-assets" style="float: right;"></span></div>
                
                <h3>Liabilities</h3>
                <table id="bs-liabilities-table"><tbody></tbody></table>
                <div class="total-row">Total Liabilities: <span id="bs-total-liabilities" style="float: right;"></span></div>

                <h3>Equity</h3>
                <table id="bs-equity-table"><tbody></tbody></table>
                <div class="total-row">Total Equity: <span id="bs-total-equity" style="float: right;"></span></div>
                
                <hr>
                <div class="total-row" style="padding: 1rem; font-size: 1.2rem;">
                    Total Liabilities & Equity: <span id="bs-total-le" style="float: right;"></span>
                </div>
            </div>
        </div>
    </main>

    <script src="js/api.js"></script>
    <script>
        function showReport(id) {
            document.querySelectorAll('.report-section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            loadReport(id);
        }

        async function loadReport(type) {
            if (type === 'trial-balance') {
                const data = await api.get('/reports/trial-balance');
                const tbody = document.querySelector('#tb-table tbody');
                tbody.innerHTML = data.rows.filter(r => r.debit > 0 || r.credit > 0).map(r => `
                    <tr>
                        <td>${r.account_code} - ${r.account_name}</td>
                        <td class="text-right">${r.debit > 0 ? r.debit.toFixed(2) : ''}</td>
                        <td class="text-right">${r.credit > 0 ? r.credit.toFixed(2) : ''}</td>
                    </tr>
                `).join('');
                document.getElementById('tb-total-debit').innerText = data.totals.debit.toFixed(2);
                document.getElementById('tb-total-credit').innerText = data.totals.credit.toFixed(2);
            } else if (type === 'general-ledger') {
                const accounts = await api.get('/accounts');
                const select = document.getElementById('ledger-account-select');
                const currentValue = select.value;
                select.innerHTML = '<option value="">-- Choose Account --</option>' + 
                    accounts.map(a => `<option value="${a.id}">${a.code} - ${a.name}</option>`).join('');
                select.value = currentValue;
            } else if (type === 'profit-loss') {
                const data = await api.get('/reports/profit-loss');
                document.querySelector('#pl-revenue-table tbody').innerHTML = data.revenue.map(r => `
                    <tr><td>${r.name}</td><td class="text-right">${r.amount.toFixed(2)}</td></tr>
                `).join('') + `<tr><td><strong>Total Revenue</strong></td><td class="text-right"><strong>${data.totalRevenue.toFixed(2)}</strong></td></tr>`;
                
                document.querySelector('#pl-expense-table tbody').innerHTML = data.expenses.map(r => `
                    <tr><td>${r.name}</td><td class="text-right">${r.amount.toFixed(2)}</td></tr>
                `).join('') + `<tr><td><strong>Total Expenses</strong></td><td class="text-right"><strong>${data.totalExpenses.toFixed(2)}</strong></td></tr>`;
                
                document.getElementById('pl-net-income').innerText = '$' + data.netIncome.toFixed(2);
            } else if (type === 'balance-sheet') {
                const data = await api.get('/reports/balance-sheet');
                document.querySelector('#bs-assets-table tbody').innerHTML = data.assets.map(r => `
                    <tr><td>${r.name}</td><td class="text-right">${r.amount.toFixed(2)}</td></tr>
                `).join('');
                document.getElementById('bs-total-assets').innerText = data.totalAssets.toFixed(2);

                document.querySelector('#bs-liabilities-table tbody').innerHTML = data.liabilities.map(r => `
                    <tr><td>${r.name}</td><td class="text-right">${r.amount.toFixed(2)}</td></tr>
                `).join('');
                document.getElementById('bs-total-liabilities').innerText = data.totalLiabilities.toFixed(2);

                document.querySelector('#bs-equity-table tbody').innerHTML = data.equity.map(r => `
                    <tr><td>${r.name}</td><td class="text-right">${r.amount.toFixed(2)}</td></tr>
                `).join('');
                document.getElementById('bs-total-equity').innerText = data.totalEquity.toFixed(2);
                
                document.getElementById('bs-total-le').innerText = data.totalLiabilitiesAndEquity.toFixed(2);
            }
        }

        async function loadLedger() {
            const accountId = document.getElementById('ledger-account-select').value;
            if (!accountId) {
                document.querySelector('#ledger-table tbody').innerHTML = '';
                return;
            }

            const entries = await api.get(`/reports/ledger?accountId=${accountId}`);
            
            // Need normal balance to calculate running balance
            const account = await api.get(`/accounts/${accountId}`);
            const isDebitNormal = account.normal_balance === 'Debit';
            
            let runningBalance = 0;
            const tbody = document.querySelector('#ledger-table tbody');
            tbody.innerHTML = entries.map(e => {
                const debit = parseFloat(e.debit || 0);
                const credit = parseFloat(e.credit || 0);
                
                if (isDebitNormal) {
                    runningBalance += (debit - credit);
                } else {
                    runningBalance += (credit - debit);
                }

                return `
                    <tr>
                        <td>${new Date(e.entry_date).toLocaleDateString()}</td>
                        <td>${e.reference || ''}</td>
                        <td>${e.description || ''}</td>
                        <td class="text-right">${debit > 0 ? debit.toFixed(2) : ''}</td>
                        <td class="text-right">${credit > 0 ? credit.toFixed(2) : ''}</td>
                        <td class="text-right">${runningBalance.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
            
            if (entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No entries found for this account.</td></tr>';
            }
        }

        loadReport('general-ledger');
    </script>
</body>
</html>
